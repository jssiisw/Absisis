name: Linux-Tailscale-RDP-Stable

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Update System
        run: sudo apt update

      - name: Install Desktop Environment
        run: |
          sudo apt install -y xfce4 xfce4-goodies xrdp dbus-x11 xorgxrdp

      - name: Configure XRDP Properly
        run: |
          # إنشاء مستخدم
          sudo useradd -m -s /bin/bash aban || true
          echo "aban:${{ secrets.RDP_PASSWORD }}" | sudo chpasswd
          sudo usermod -aG sudo aban

          # إنشاء جلسة XFCE نظيفة
          sudo -u aban bash -c 'echo "unset DBUS_SESSION_BUS_ADDRESS" > ~/.xsession'
          sudo -u aban bash -c 'echo "unset XDG_RUNTIME_DIR" >> ~/.xsession'
          sudo -u aban bash -c 'echo "exec startxfce4" >> ~/.xsession'

          sudo chmod +x /home/aban/.xsession

          # ضبط XRDP
          sudo sed -i 's/3389/3389/' /etc/xrdp/xrdp.ini
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: Deploy Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Show Connection Info
        run: |
          echo "===== RDP READY ====="
          tailscale ip -4
          echo "User: aban"
          sleep 21600
