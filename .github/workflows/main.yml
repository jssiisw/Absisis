name: Ubuntu + Tailscale + RDP + User aban

on: [workflow_dispatch]

jobs:
  setup-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTH_KEY }} --accept-routes --ssh
          echo "âœ… Tailscale connected"

      - name: Get Tailscale IP
        run: |
          echo "=========================================="
          echo "ğŸŒ Tailscale IP: $(tailscale ip -4)"
          echo "=========================================="

      - name: Install Desktop Environment
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update -y
          
          # ØªØ«Ø¨ÙŠØª XFCE ÙƒØ§Ù…Ù„
          sudo apt-get install -y xfce4 xfce4-goodies xfce4-session
          
          # ØªØ«Ø¨ÙŠØª D-Bus (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)
          sudo apt-get install -y dbus-x11
          
          echo "âœ… Desktop installed"

      - name: Install & Configure XRDP
        run: |
          sudo apt-get install -y xrdp
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ XRDP Ù„ÙŠØ³ØªØ®Ø¯Ù… XFCE
          echo "xfce4-session" | sudo tee /etc/skel/.xsession
          
          # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ XRDP
          sudo systemctl restart xrdp
          
          echo "âœ… XRDP configured"

      - name: Create User 'aban'
        run: |
          sudo useradd -m -s /bin/bash aban
          echo "aban:aban" | sudo chpasswd
          sudo usermod -aG sudo aban
          sudo usermod -aG ssl-cert aban
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ XFCE Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
          sudo mkdir -p /home/aban/.config/xfce4
          echo "xfce4-session" | sudo tee /home/aban/.xsession
          sudo chown -R aban:aban /home/aban
          
          echo "âœ… User 'aban' ready"

      - name: Fix D-Bus & Permissions
        run: |
          # ØªØ´ØºÙŠÙ„ D-Bus
          sudo systemctl start dbus || true
          
          # Ø¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„Ù€ aban
          sudo usermod -aG video aban
          
          echo "âœ… Permissions fixed"

      - name: Show Connection Info
        run: |
          echo ""
          echo "=========================================="
          echo "âœ… READY TO CONNECT"
          echo "=========================================="
          echo "IP: $(tailscale ip -4)"
          echo "Port: 3389"
          echo "Username: aban"
          echo "Password: aban"
          echo "=========================================="

      - name: Keep Alive
        run: |
          echo "ğŸŸ¢ RDP Server running..."
          sleep 21600
