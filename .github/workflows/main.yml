name: Linux-Tailscale-RDP-Fixed

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Update System
        run: sudo apt update

      - name: Install XFCE + XRDP + Fix Session
        run: |
          sudo apt install -y xfce4 xfce4-goodies xrdp dbus-x11

          # إنشاء مستخدم
          sudo useradd -m -s /bin/bash aban || true
          echo "aban:${{ secrets.RDP_PASSWORD }}" | sudo chpasswd
          sudo usermod -aG sudo aban

          # ضبط جلسة المستخدم
          sudo -u aban bash -c 'echo "dbus-launch --exit-with-session startxfce4" > ~/.xsession'
          sudo chmod +x /home/aban/.xsession

          # تعديل startwm.sh لإجبار XFCE
          sudo sed -i 's/^test -x/#test -x/' /etc/xrdp/startwm.sh
          sudo sed -i 's/^exec/#exec/' /etc/xrdp/startwm.sh
          echo "startxfce4" | sudo tee -a /etc/xrdp/startwm.sh

          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: Deploy Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Show Connection Info
        run: |
          echo "---- RDP READY ----"
          tailscale ip -4
          echo "User: aban"
          sleep 21600
