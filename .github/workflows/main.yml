name: Kali-Tailscale-Ultra-Fixed

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          
      - name: Connect to Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
          
      - name: Setup User and Kali GUI
        run: |
          sudo apt update
          # تثبيت الواجهة الرسومية مع المكتبات المفقودة التي سببت الخطأ في الصورة
          sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-goodies xrdp xorg dbus-x11 x11-xserver-utils
          
          # إنشاء المستخدم وتأمين الصلاحيات
          sudo useradd -m -s /bin/bash aban || true
          echo "aban:abanAWAD500" | sudo chpasswd
          sudo adduser aban sudo || true
          
          # إعدادات الـ RDP المتقدمة (لمنع خطأ الفشل في الجلسة)
          echo "xfce4-session" > /home/aban/.xsession
          sudo chown aban:aban /home/aban/.xsession
          
          # تعديل إعدادات xrdp للعمل مع dbus
          sudo sed -i 's/test -x \/etc\/X11\/Xsession \&\& exec \/etc\/X11\/Xsession/exec startxfce4/g' /etc/xrdp/startwm.sh
          
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: Keep Alive for 6 Hours
        run: |
          echo "Your Kali IP is:"
          tailscale ip -4
          echo "Connection is ready! Use Username: aban | Password: abanAWAD500"
          # يبقي الجلسة مفتوحة لمدة 6 ساعات
          sleep 21600
