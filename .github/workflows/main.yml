name: Kali-Ultimate-Solution-v3

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          
      - name: Connect to Tailscale
        run: |
          # تأكد أن المفتاح في Secrets هو Auth Key يبدأ بـ tskey-auth
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
          
      - name: Setup User & Fix Desktop Session
        run: |
          sudo apt update
          # تثبيت الواجهة مع حزم الاستقرار الأساسية للـ RDP
          sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-goodies xrdp dbus-x11 x11-xserver-utils
          
          # إنشاء المستخدم وتحديد كلمة السر
          sudo useradd -m -s /bin/bash aban || true
          echo "aban:abanAWAD500" | sudo chpasswd
          sudo adduser aban sudo || true
          
          # الحل النهائي لمشكلة الفشل في الجلسة (Failsafe)
          # نقوم بمسح أي إعدادات قديمة وإجبار المستخدم على تشغيل xfce
          sudo rm -f /home/aban/.xsession
          sudo -u aban bash -c 'echo "exec startxfce4" > ~/.xsession'
          sudo chmod +x /home/aban/.xsession
          
          # تعديل ملف تشغيل الـ RDP ليتجاوز الأخطاء ويشغل الواجهة مباشرة
          sudo sed -i 's/^. \/etc\/X11\/Xsession/#. \/etc\/X11\/Xsession/g' /etc/xrdp/startwm.sh
          echo "exec startxfce4" | sudo tee -a /etc/xrdp/startwm.sh
          
          # إعادة تشغيل الخدمات
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: Keep Alive (6 Hours)
        run: |
          echo "==== السيرفر جاهز يا وحش ===="
          echo "IP Address: $(tailscale ip -4)"
          echo "User: aban | Pass: abanAWAD500"
          echo "============================"
          # السيرفر سيبقى يعمل لمدة 6 ساعات متواصلة
          sleep 21600
